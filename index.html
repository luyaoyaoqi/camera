<!DOCTYPE html>

<head>
  <meta charset="utf-8">
  </meta>
  <title>ç½‘é¡µæ‹ç…§ç¤ºä¾‹ï¼ˆå¸¦ç›¸æœºåˆ‡æ¢ï¼‰</title>
  <style>
    /* æ·»åŠ åŸºæœ¬æ ·å¼ */
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      text-align: center;
    }

    #video-container {
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }

    #video-mask {
      position: absolute;
      display: inline-block;
      border: 2px dashed #fff;
    }

    #video {
      width: 50vmin;
      height: 50vmin;
      object-fit: cover;
    }

    button {
      padding: 10px 20px;
      font-size: 16px;
      margin: 5px;
      margin-top: 16px;
    }

    #photo-container {
      margin-top: 20px;
      text-align: center;
    }

    #camera-info {
      margin: 10px 0;
      font-size: 14px;
      color: #666;
    }

    #camera-controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
      gap: 5px;
    }

    #device-selector {
      padding: 10px;
      font-size: 16px;
      margin: 5px;
      margin-top: 16px;
      max-width: 200px;
    }
  </style>
</head>

<body>
  <h1>ç½‘é¡µæ‹ç…§</h1>
  <div id="video-container">
    <video id="video" autoplay></video>
    <div id="video-mask"></div>
  </div>
  <div id="camera-info"></div>
  <div id="camera-controls">
    <button onclick="takePhoto()">æ‹ç…§ ğŸ“·</button>
    <button onclick="switchSquare()">æ­£æ–¹å½¢è£åˆ‡ â—¼ï¸</button>
    <button onclick="switchCamera()">åˆ‡æ¢ç›¸æœº ğŸ”„</button>
    <button onclick="rotateCamera()">æ—‹è½¬ç›¸æœº ğŸ”„</button>
    <button onclick="switchAspectRatio()">ç›¸æœºæ¯”ä¾‹ 16:9</button>
    <select id="device-selector" onchange="changeCameraDevice(this.value)" style="display:none;"></select>
  </div>
  <div id="photo-container"><canvas id="canvas"></canvas></div>

  <script>
    let stream;
    let video = document.getElementById("video");
    let canvas = document.getElementById("canvas");
    let videoContainer = document.getElementById("video-container");
    let videoMask = document.getElementById("video-mask");
    let currentFacingMode = 'environment'; // é»˜è®¤ä½¿ç”¨åç½®æ‘„åƒå¤´
    let photoContainer = document.getElementById("photo-container");
    let rotateVideo = 0; // è§†é¢‘æ—‹è½¬è§’åº¦ (0, 90, 180, 270)
    let imgIsSquare = false; // æ˜¯å¦è£å‰ªä¸ºæ­£æ–¹å½¢
    let aspectRatios = [
      { width: 16, height: 9 },  // 16:9 æ¯”ä¾‹
      { width: 4, height: 3 }    // 4:3 æ¯”ä¾‹
    ];
    let currentAspectRatioIndex = 0; // å½“å‰ä½¿ç”¨çš„æ¯”ä¾‹ç´¢å¼•
    let currentDeviceId = null; // å½“å‰é€‰ä¸­çš„è®¾å¤‡ID

    // åˆå§‹åŒ–æ‘„åƒå¤´
    function initCamera(facingMode) {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }

      // è·å–æ‰€æœ‰è§†é¢‘è¾“å…¥è®¾å¤‡
      navigator.mediaDevices.enumerateDevices()
        .then(devices => {
          const videoDevices = devices.filter(device => device.kind === 'videoinput');
          console.log('å¯ç”¨çš„æ‘„åƒå¤´è®¾å¤‡:', videoDevices);

          // æ›´æ–°è®¾å¤‡é€‰æ‹©å™¨
          updateDeviceSelector(videoDevices);

          if (videoDevices.length === 0) {
            throw new Error("æœªæ‰¾åˆ°è§†é¢‘è®¾å¤‡");
          }

          // å…ˆè·å–è®¾å¤‡èƒ½åŠ›ï¼Œå†è®¾ç½®åˆé€‚çš„åˆ†è¾¨ç‡
          let constraints = { video: {} };

          // å¦‚æœå·²æœ‰é€‰ä¸­çš„è®¾å¤‡IDï¼Œåˆ™ä¼˜å…ˆä½¿ç”¨è¯¥è®¾å¤‡
          if (currentDeviceId && videoDevices.some(device => device.deviceId === currentDeviceId)) {
            constraints.video.deviceId = { exact: currentDeviceId };
          } else {
            // å¦åˆ™æŸ¥æ‰¾å…·æœ‰æŒ‡å®šfacingModeçš„è®¾å¤‡
            let targetDevice = null;
            if (facingMode) {
              targetDevice = videoDevices.find(device =>
                device.label.toLowerCase().includes(facingMode === 'environment' ? 'back' : 'front') ||
                device.label.toLowerCase().includes(facingMode === 'environment' ? 'å' : 'å‰')
              );
            }

            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç‰¹å®šæ–¹å‘çš„è®¾å¤‡ï¼Œåˆ™ä½¿ç”¨ç¬¬ä¸€ä¸ªè®¾å¤‡
            if (!targetDevice && videoDevices.length > 0) {
              targetDevice = videoDevices[0];
            }

            // å¦‚æœæ‰¾åˆ°äº†å…·ä½“è®¾å¤‡ï¼Œåˆ™ä½¿ç”¨deviceIdçº¦æŸ
            if (targetDevice) {
              constraints.video.deviceId = { exact: targetDevice.deviceId };
              currentDeviceId = targetDevice.deviceId; // ä¿å­˜è®¾å¤‡ID
              console.log('ä½¿ç”¨æ‘„åƒå¤´è®¾å¤‡:', targetDevice.label);
            } else if (facingMode) {
              // å¦åˆ™å›é€€åˆ°facingModeçº¦æŸ
              constraints.video.facingMode = facingMode;
            }
          }

          // å…ˆè·å–ä¸€ä¸ªåŸºç¡€æµä»¥æŸ¥è¯¢è®¾å¤‡èƒ½åŠ›
          return navigator.mediaDevices.getUserMedia(constraints);
        })
        .then(tempStream => {
          // è·å–è§†é¢‘è½¨é“åŠå…¶èƒ½åŠ›
          const videoTrack = tempStream.getVideoTracks()[0];
          const capabilities = videoTrack.getCapabilities();

          // æ—¥å¿—è¾“å‡ºæ”¯æŒçš„åˆ†è¾¨ç‡èŒƒå›´
          console.log(`ç›¸æœºæ”¯æŒçš„åˆ†è¾¨ç‡èŒƒå›´: ${capabilities.width.min}x${capabilities.height.min} è‡³ ${capabilities.width.max}x${capabilities.height.max}`);

          // åœæ­¢ä¸´æ—¶æµ
          tempStream.getTracks().forEach(track => track.stop());

          // æ ¹æ®æ”¯æŒçš„æœ€å¤§åˆ†è¾¨ç‡å’Œé€‰å®šçš„å®½é«˜æ¯”è®¾ç½®çº¦æŸ
          const currentRatio = aspectRatios[currentAspectRatioIndex];
          let targetWidth, targetHeight;

          // ä½¿ç”¨æ‘„åƒå¤´æ”¯æŒçš„æœ€å¤§å®½åº¦ï¼Œä½†è®¾ç½®ä¸€ä¸ªåˆç†çš„ä¸Šé™
          if (capabilities.width && capabilities.width.max) {
            // è®¾ç½®æœ€å¤§å®½åº¦ä¸è¶…è¿‡4096ï¼Œä»¥é˜²æŸäº›è®¾å¤‡æŠ¥å‘Šä¸åˆç†çš„æ•°å€¼
            targetWidth = Math.min(capabilities.width.max, 4096);
            targetHeight = Math.round(targetWidth * currentRatio.height / currentRatio.width);

            // ç¡®ä¿é«˜åº¦ä¹Ÿåœ¨æ”¯æŒèŒƒå›´å†…
            if (capabilities.height && capabilities.height.max && targetHeight > capabilities.height.max) {
              targetHeight = capabilities.height.max;
              targetWidth = Math.round(targetHeight * currentRatio.width / currentRatio.height);
            }
          } else {
            // å¦‚æœæ— æ³•è·å–æœ€å¤§åˆ†è¾¨ç‡ï¼Œåˆ™ä½¿ç”¨é»˜è®¤å€¼
            targetWidth = 1920;
            targetHeight = Math.round(targetWidth * currentRatio.height / currentRatio.width);
          }

          // æ„å»ºæœ€ç»ˆçº¦æŸæ¡ä»¶ï¼Œä½¿ç”¨minè€Œä¸æ˜¯idealé¿å…è¿‡äºä¸¥æ ¼çš„çº¦æŸ
          const finalConstraints = {
            video: {
              width: { ideal: targetWidth },
              height: { ideal: targetHeight }
            }
          };

          // å¦‚æœå·²æœ‰è®¾å¤‡IDï¼Œåˆ™æ·»åŠ åˆ°çº¦æŸä¸­
          if (currentDeviceId) {
            finalConstraints.video.deviceId = { exact: currentDeviceId };
          } else if (facingMode) {
            finalConstraints.video.facingMode = facingMode;
          }

          console.log(`è®¾ç½®ç›¸æœºåˆ†è¾¨ç‡: ${targetWidth}x${targetHeight}`);

          // ä½¿ç”¨ä¼˜åŒ–åçš„çº¦æŸé‡æ–°è¯·æ±‚åª’ä½“æµ
          return navigator.mediaDevices.getUserMedia(finalConstraints);
        })
        .then(function (s) {
          stream = s;
          video.srcObject = s;

          // æ˜¾ç¤ºæ‘„åƒå¤´ä¿¡æ¯
          showCameraInfo();

          // æ›´æ–°è®¾å¤‡é€‰æ‹©å™¨
          navigator.mediaDevices.enumerateDevices()
            .then(devices => {
              const videoDevices = devices.filter(device => device.kind === 'videoinput');
              updateDeviceSelector(videoDevices);
            });

          // è§†é¢‘å…ƒæ•°æ®åŠ è½½åè·å–å®é™…å®½é«˜æ¯”ä¾‹
          return new Promise((resolve) => {
            video.onloadedmetadata = () => {
              const videoWidth = video.videoWidth;
              const videoHeight = video.videoHeight;
              console.log(`å®é™…è§†é¢‘åˆ†è¾¨ç‡: ${videoWidth}x${videoHeight}, æ¯”ä¾‹: ${videoWidth / videoHeight}`);

              // è®¡ç®—å®½é«˜æ¯”å¹¶è®¾ç½®å®¹å™¨æ ·å¼
              if (videoWidth && videoHeight) {
                const aspectRatio = videoWidth / videoHeight;
                video.style.width = `${video.offsetHeight * aspectRatio}px`;
                video.setAttribute('width', video.style.width);
                video.style.height = `${video.offsetHeight}px`;
                video.setAttribute('height', video.style.height);
                videoMask.style.width = video.style.height;
                videoMask.style.height = video.style.height;
                setSquare();
              }

              resolve();
            };
          });
        })
        .catch(function (error) {
          console.error("æ— æ³•è·å–æ‘„åƒå¤´: ", error);
          // å¦‚æœæ˜¯å› ä¸ºçº¦æŸæ¡ä»¶å¤ªä¸¥æ ¼å¯¼è‡´çš„é”™è¯¯ï¼Œå°è¯•ä½¿ç”¨æ›´å®½æ¾çš„çº¦æŸ
          if (error.name === 'OverconstrainedError') {
            console.log("å°è¯•ä½¿ç”¨æ›´å®½æ¾çš„çº¦æŸæ¡ä»¶...");
            fallbackToBasicConstraints(facingMode);
          } else {
            alert("æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼Œè¯·ç¡®ä¿æ‚¨å·²æˆäºˆæƒé™ã€‚é”™è¯¯ä¿¡æ¯: " + error.message);
          }
        });
    }

    // å½“çº¦æŸæ¡ä»¶è¿‡äºä¸¥æ ¼æ—¶çš„å¤‡ç”¨æ–¹æ¡ˆ
    function fallbackToBasicConstraints(facingMode) {
      const basicConstraints = { video: {} };

      if (currentDeviceId) {
        basicConstraints.video.deviceId = { exact: currentDeviceId };
      } else if (facingMode) {
        basicConstraints.video.facingMode = facingMode;
      }

      navigator.mediaDevices.getUserMedia(basicConstraints)
        .then(function (s) {
          stream = s;
          video.srcObject = s;

          // æ˜¾ç¤ºæ‘„åƒå¤´ä¿¡æ¯
          showCameraInfo();

          // æ›´æ–°è®¾å¤‡é€‰æ‹©å™¨
          navigator.mediaDevices.enumerateDevices()
            .then(devices => {
              const videoDevices = devices.filter(device => device.kind === 'videoinput');
              updateDeviceSelector(videoDevices);
            });

          // è§†é¢‘å…ƒæ•°æ®åŠ è½½åè·å–å®é™…å®½é«˜æ¯”ä¾‹
          video.onloadedmetadata = () => {
            const videoWidth = video.videoWidth;
            const videoHeight = video.videoHeight;
            console.log(`å®é™…è§†é¢‘åˆ†è¾¨ç‡: ${videoWidth}x${videoHeight}, æ¯”ä¾‹: ${videoWidth / videoHeight}`);

            if (videoWidth && videoHeight) {
              const aspectRatio = videoWidth / videoHeight;
              video.style.width = `${video.offsetHeight * aspectRatio}px`;
              video.setAttribute('width', video.style.width);
              video.style.height = `${video.offsetHeight}px`;
              video.setAttribute('height', video.style.height);
              videoMask.style.width = video.style.height;
              videoMask.style.height = video.style.height;
              setSquare();
            }
          };
        })
        .catch(function (error) {
          console.error("å³ä½¿ä½¿ç”¨å®½æ¾çº¦æŸä¹Ÿæ— æ³•è·å–æ‘„åƒå¤´: ", error);
          alert("æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼Œè¯·ç¡®ä¿æ‚¨å·²æˆäºˆæƒé™ã€‚é”™è¯¯ä¿¡æ¯: " + error.message);
        });
    }

    // æ›´æ–°è®¾å¤‡é€‰æ‹©å™¨
    function updateDeviceSelector(devices) {
      const selector = document.getElementById('device-selector');
      if (devices.length <= 1) {
        selector.style.display = 'none';
        return;
      }

      selector.innerHTML = '';
      devices.forEach((device, index) => {
        const option = document.createElement('option');
        option.value = device.deviceId;
        option.text = device.label || `æ‘„åƒå¤´ ${index + 1}`;
        selector.appendChild(option);
      });

      // é€‰æ‹©å½“å‰ä½¿ç”¨çš„è®¾å¤‡
      if (currentDeviceId) {
        selector.value = currentDeviceId;
      }

      selector.style.display = 'inline-block';
    }

    // åˆ‡æ¢åˆ°æŒ‡å®šè®¾å¤‡
    function changeCameraDevice(deviceId) {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }

      // ä¿å­˜å½“å‰è®¾å¤‡ID
      currentDeviceId = deviceId;

      // å…ˆè·å–è®¾å¤‡èƒ½åŠ›ï¼Œå†è®¾ç½®åˆé€‚çš„åˆ†è¾¨ç‡
      const tempConstraints = {
        video: {
          deviceId: { exact: deviceId }
        }
      };

      navigator.mediaDevices.getUserMedia(tempConstraints)
        .then(tempStream => {
          // è·å–è§†é¢‘è½¨é“åŠå…¶èƒ½åŠ›
          const videoTrack = tempStream.getVideoTracks()[0];
          const capabilities = videoTrack.getCapabilities();

          // æ—¥å¿—è¾“å‡ºæ”¯æŒçš„åˆ†è¾¨ç‡èŒƒå›´
          console.log(`ç›¸æœºæ”¯æŒçš„åˆ†è¾¨ç‡èŒƒå›´: ${capabilities.width.min}x${capabilities.height.min} è‡³ ${capabilities.width.max}x${capabilities.height.max}`);

          // åœæ­¢ä¸´æ—¶æµ
          tempStream.getTracks().forEach(track => track.stop());

          // æ ¹æ®æ”¯æŒçš„æœ€å¤§åˆ†è¾¨ç‡å’Œé€‰å®šçš„å®½é«˜æ¯”è®¾ç½®çº¦æŸ
          const currentRatio = aspectRatios[currentAspectRatioIndex];
          let targetWidth, targetHeight;

          // ä½¿ç”¨æ‘„åƒå¤´æ”¯æŒçš„æœ€å¤§å®½åº¦ï¼Œä½†è®¾ç½®ä¸€ä¸ªåˆç†çš„ä¸Šé™
          if (capabilities.width && capabilities.width.max) {
            // è®¾ç½®æœ€å¤§å®½åº¦ä¸è¶…è¿‡4096ï¼Œä»¥é˜²æŸäº›è®¾å¤‡æŠ¥å‘Šä¸åˆç†çš„æ•°å€¼
            targetWidth = Math.min(capabilities.width.max, 4096);
            targetHeight = Math.round(targetWidth * currentRatio.height / currentRatio.width);

            // ç¡®ä¿é«˜åº¦ä¹Ÿåœ¨æ”¯æŒèŒƒå›´å†…
            if (capabilities.height && capabilities.height.max && targetHeight > capabilities.height.max) {
              targetHeight = capabilities.height.max;
              targetWidth = Math.round(targetHeight * currentRatio.width / currentRatio.height);
            }
          } else {
            // å¦‚æœæ— æ³•è·å–æœ€å¤§åˆ†è¾¨ç‡ï¼Œåˆ™ä½¿ç”¨é»˜è®¤å€¼
            targetWidth = 1920;
            targetHeight = Math.round(targetWidth * currentRatio.height / currentRatio.width);
          }

          // æ„å»ºæœ€ç»ˆçº¦æŸæ¡ä»¶ï¼Œä½¿ç”¨minè€Œä¸æ˜¯idealé¿å…è¿‡äºä¸¥æ ¼çš„çº¦æŸ
          const constraints = {
            video: {
              deviceId: { exact: deviceId },
              width: { min: 640, ideal: targetWidth },
              height: { min: 480, ideal: targetHeight }
            }
          };

          console.log(`è®¾ç½®ç›¸æœºåˆ†è¾¨ç‡: ${targetWidth}x${targetHeight}`);

          // ä½¿ç”¨ä¼˜åŒ–åçš„çº¦æŸé‡æ–°è¯·æ±‚åª’ä½“æµ
          return navigator.mediaDevices.getUserMedia(constraints);
        })
        .then(function (s) {
          stream = s;
          video.srcObject = s;

          // æ˜¾ç¤ºæ‘„åƒå¤´ä¿¡æ¯
          showCameraInfo();

          // æ›´æ–°è®¾å¤‡é€‰æ‹©å™¨
          navigator.mediaDevices.enumerateDevices()
            .then(devices => {
              const videoDevices = devices.filter(device => device.kind === 'videoinput');
              updateDeviceSelector(videoDevices);
            });

          // è§†é¢‘å…ƒæ•°æ®åŠ è½½åè·å–å®é™…å®½é«˜æ¯”ä¾‹
          video.onloadedmetadata = () => {
            const videoWidth = video.videoWidth;
            const videoHeight = video.videoHeight;
            console.log(`å®é™…è§†é¢‘åˆ†è¾¨ç‡: ${videoWidth}x${videoHeight}, æ¯”ä¾‹: ${videoWidth / videoHeight}`);

            if (videoWidth && videoHeight) {
              const aspectRatio = videoWidth / videoHeight;
              video.style.width = `${video.offsetHeight * aspectRatio}px`;
              video.setAttribute('width', video.style.width);
              video.style.height = `${video.offsetHeight}px`;
              video.setAttribute('height', video.style.height);
              videoMask.style.width = video.style.height;
              videoMask.style.height = video.style.height;
              setSquare();
            }
          };
        })
        .catch(function (error) {
          console.error("æ— æ³•åˆ‡æ¢åˆ°æŒ‡å®šæ‘„åƒå¤´: ", error);
          // å¦‚æœæ˜¯å› ä¸ºçº¦æŸæ¡ä»¶å¤ªä¸¥æ ¼å¯¼è‡´çš„é”™è¯¯ï¼Œå°è¯•ä½¿ç”¨æ›´å®½æ¾çš„çº¦æŸ
          if (error.name === 'OverconstrainedError') {
            console.log("å°è¯•ä½¿ç”¨æ›´å®½æ¾çš„çº¦æŸæ¡ä»¶...");
            fallbackToBasicConstraintsForDevice(deviceId);
          } else {
            alert("æ— æ³•åˆ‡æ¢åˆ°æŒ‡å®šæ‘„åƒå¤´: " + error.message);
          }
        });
    }

    // å½“çº¦æŸæ¡ä»¶è¿‡äºä¸¥æ ¼æ—¶çš„å¤‡ç”¨æ–¹æ¡ˆï¼ˆé’ˆå¯¹ç‰¹å®šè®¾å¤‡ï¼‰
    function fallbackToBasicConstraintsForDevice(deviceId) {
      const basicConstraints = {
        video: {
          deviceId: { exact: deviceId }
        }
      };

      navigator.mediaDevices.getUserMedia(basicConstraints)
        .then(function (s) {
          stream = s;
          video.srcObject = s;

          // æ˜¾ç¤ºæ‘„åƒå¤´ä¿¡æ¯
          showCameraInfo();

          // æ›´æ–°è®¾å¤‡é€‰æ‹©å™¨
          navigator.mediaDevices.enumerateDevices()
            .then(devices => {
              const videoDevices = devices.filter(device => device.kind === 'videoinput');
              updateDeviceSelector(videoDevices);
            });

          // è§†é¢‘å…ƒæ•°æ®åŠ è½½åè·å–å®é™…å®½é«˜æ¯”ä¾‹
          video.onloadedmetadata = () => {
            const videoWidth = video.videoWidth;
            const videoHeight = video.videoHeight;
            console.log(`å®é™…è§†é¢‘åˆ†è¾¨ç‡: ${videoWidth}x${videoHeight}, æ¯”ä¾‹: ${videoWidth / videoHeight}`);

            if (videoWidth && videoHeight) {
              const aspectRatio = videoWidth / videoHeight;
              video.style.width = `${video.offsetHeight * aspectRatio}px`;
              video.setAttribute('width', video.style.width);
              video.style.height = `${video.offsetHeight}px`;
              video.setAttribute('height', video.style.height);
              videoMask.style.width = video.style.height;
              videoMask.style.height = video.style.height;
              setSquare();
            }
          };
        })
        .catch(function (error) {
          console.error("å³ä½¿ä½¿ç”¨å®½æ¾çº¦æŸä¹Ÿæ— æ³•åˆ‡æ¢åˆ°æŒ‡å®šæ‘„åƒå¤´: ", error);
          alert("æ— æ³•åˆ‡æ¢åˆ°æŒ‡å®šæ‘„åƒå¤´: " + error.message);
        });
    }

    // æ˜¾ç¤ºå½“å‰æ‘„åƒå¤´ä¿¡æ¯
    function showCameraInfo() {
      const infoDiv = document.getElementById('camera-info');
      if (stream && stream.getVideoTracks().length > 0) {
        const track = stream.getVideoTracks()[0];
        const settings = track.getSettings();
        const capabilities = track.getCapabilities();

        let info = `å½“å‰æ‘„åƒå¤´: ${settings.deviceId ? settings.deviceId.substring(0, 8) : 'æœªçŸ¥'}`;
        info += ` | åˆ†è¾¨ç‡: ${settings.width}x${settings.height}`;
        if (settings.frameRate) {
          info += ` | å¸§ç‡: ${Math.round(settings.frameRate)}fps`;
        }

        infoDiv.textContent = info;
      } else {
        infoDiv.textContent = 'æœªè¿æ¥æ‘„åƒå¤´';
      }
    }

    // æ‹ç…§å‡½æ•°
    function takePhoto() {
      // ä½¿ç”¨è§†é¢‘å®é™…åˆ†è¾¨ç‡è€Œä¸æ˜¯æ˜¾ç¤ºå°ºå¯¸
      const videoWidth = video.videoWidth;
      const videoHeight = video.videoHeight;
      const displayWidth = video.offsetWidth;
      const displayHeight = video.offsetHeight;

      // æ ¹æ®æ—‹è½¬è§’åº¦ç¡®å®šCanvaså°ºå¯¸
      const canvasWidth = (rotateVideo === 90 || rotateVideo === 270) ? videoHeight : videoWidth;
      const canvasHeight = (rotateVideo === 90 || rotateVideo === 270) ? videoWidth : videoHeight;
      canvas.width = canvasWidth;
      canvas.height = canvasHeight;

      const ctx = canvas.getContext("2d");

      if (rotateVideo === 90) {
        // é¡ºæ—¶é’ˆæ—‹è½¬90åº¦
        ctx.translate(canvasWidth, 0);
        ctx.rotate(90 * Math.PI / 180);
      } else if (rotateVideo === 180) {
        // æ—‹è½¬180åº¦
        ctx.translate(canvasWidth, canvasHeight);
        ctx.rotate(180 * Math.PI / 180);
      } else if (rotateVideo === 270) {
        // é€†æ—¶é’ˆæ—‹è½¬90åº¦(æˆ–é¡ºæ—¶é’ˆ270åº¦)
        ctx.translate(0, canvasHeight);
        ctx.rotate(-90 * Math.PI / 180);
      }

      // ç»˜åˆ¶è§†é¢‘å†…å®¹ï¼Œä½¿ç”¨å®é™…åˆ†è¾¨ç‡è€Œä¸æ˜¯æ˜¾ç¤ºå°ºå¯¸
      ctx.drawImage(
        video,
        0,
        0,
        videoWidth,
        videoHeight);

      // åˆ›å»ºå¹¶æ˜¾ç¤ºå›¾ç‰‡
      const img = document.createElement("img");

      // å¦‚æœéœ€è¦è£å‰ªä¸ºæ­£æ–¹å½¢ï¼Œåˆ™è¿›è¡Œè£å‰ª 
      if (imgIsSquare) {
        const minDimension = Math.min(canvasWidth, canvasHeight);
        const startX = (canvasWidth - minDimension) / 2;
        const startY = (canvasHeight - minDimension) / 2;
        const croppedCanvas = document.createElement("canvas");
        croppedCanvas.width = minDimension;
        croppedCanvas.height = minDimension;
        const croppedCtx = croppedCanvas.getContext("2d");
        croppedCtx.drawImage(canvas, startX, startY, minDimension, minDimension,
          0, 0, minDimension, minDimension);
        img.src = croppedCanvas.toDataURL("image/png");
      } else {
        img.src = canvas.toDataURL("image/png");
      }

      img.style.maxWidth = "100%";
      img.alt = "æ‹æ‘„çš„ç…§ç‰‡";

      photoContainer.innerHTML = '';
      photoContainer.appendChild(img);
    }
    // æ§åˆ¶æ­£æ–¹å½¢æ˜¾ç¤º
    function setSquare() {
      if (imgIsSquare) {
        videoContainer.style.width = video.style.height;
        videoContainer.style.height = video.style.height;
        videoContainer.style.removeProperty('zoom');
        photoContainer.style.removeProperty('zoom');
      } else {
        if (rotateVideo === 90 || rotateVideo === 270) {
          videoContainer.style.width = video.offsetHeight + 'px';
          videoContainer.style.height = video.offsetWidth + 'px';
          videoContainer.style.zoom = `calc(${video.offsetHeight / video.offsetWidth})`;
          photoContainer.style.zoom = `calc(${video.offsetHeight / video.offsetWidth})`;
        } else {
          videoContainer.style.width = video.style.width;
          videoContainer.style.height = video.style.height;
          videoContainer.style.removeProperty('zoom');
          photoContainer.style.removeProperty('zoom');
        }
      }
    }

    function switchSquare() {
      imgIsSquare = !imgIsSquare; // åˆ‡æ¢æ­£æ–¹å½¢è£å‰ªçŠ¶æ€
      setSquare();
    }

    // åˆ‡æ¢ç›¸æœºå‡½æ•° - æ”¹è¿›ç‰ˆ
    function switchCamera() {
      navigator.mediaDevices.enumerateDevices()
        .then(devices => {
          const videoDevices = devices.filter(device => device.kind === 'videoinput');
          if (videoDevices.length <= 1) {
            // å¦‚æœåªæœ‰ä¸€ä¸ªæˆ–æ²¡æœ‰æ‘„åƒå¤´ï¼Œä½¿ç”¨facingModeæ–¹å¼åˆ‡æ¢
            currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
            initCamera(currentFacingMode);
          } else {
            // å¦‚æœæœ‰å¤šä¸ªæ‘„åƒå¤´ï¼Œè®©ç”¨æˆ·æ‰‹åŠ¨é€‰æ‹©æˆ–è€…å¾ªç¯åˆ‡æ¢
            cycleCameraDevice(videoDevices);
          }
        })
        .catch(error => {
          console.error("æ— æ³•æšä¸¾è®¾å¤‡: ", error);
          // å›é€€åˆ°åŸæ¥çš„æ–¹å¼
          currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
          initCamera(currentFacingMode);
        });
    }

    // å¾ªç¯åˆ‡æ¢æ‘„åƒå¤´è®¾å¤‡
    function cycleCameraDevice(devices) {
      if (currentDeviceId) {
        const currentIndex = devices.findIndex(device => device.deviceId === currentDeviceId);
        const nextIndex = (currentIndex + 1) % devices.length;
        changeCameraDevice(devices[nextIndex].deviceId);
      } else {
        // å¦‚æœå½“å‰æ²¡æœ‰æ´»åŠ¨æµï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ªè®¾å¤‡
        changeCameraDevice(devices[0].deviceId);
      }
    }

    // æ—‹è½¬ç›¸æœºå‡½æ•°
    function setCamera() {
      video.style.transform = `rotate(${rotateVideo}deg)`;
    }

    function rotateCamera() {
      // åœ¨0, 90, 180, 270ä¹‹é—´å¾ªç¯åˆ‡æ¢
      if (rotateVideo === 0) {
        rotateVideo = 90;
      } else if (rotateVideo === 90) {
        rotateVideo = 180;
      } else if (rotateVideo === 180) {
        rotateVideo = 270;
      } else if (rotateVideo === 270) {
        rotateVideo = 0;
      }

      setCamera();
      setSquare();
    }

    // åˆ‡æ¢ç”»é¢æ¯”ä¾‹
    function switchAspectRatio() {
      currentAspectRatioIndex = (currentAspectRatioIndex + 1) % aspectRatios.length;
      const ratio = aspectRatios[currentAspectRatioIndex];
      console.log(`åˆ‡æ¢åˆ° ${ratio.width}:${ratio.height} æ¯”ä¾‹`);

      // æ›´æ–°æŒ‰é’®æ–‡æœ¬æ˜¾ç¤ºå½“å‰æ¯”ä¾‹
      const buttons = document.querySelectorAll('button');
      buttons.forEach(button => {
        if (button.textContent.includes('ç›¸æœºæ¯”ä¾‹')) {
          button.textContent = `ç›¸æœºæ¯”ä¾‹ ${ratio.width}:${ratio.height}`;
        }
      });

      // é‡æ–°åˆå§‹åŒ–æ‘„åƒå¤´ï¼Œä½†ä¿æŒå½“å‰è®¾å¤‡é€‰æ‹©
      initCamera(currentFacingMode);
    }

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–æ‘„åƒå¤´
    document.addEventListener('DOMContentLoaded', () => {
      initCamera(currentFacingMode);
      // åˆå§‹åŒ–æ—¶è®¾ç½®æ¯”ä¾‹æŒ‰é’®çš„æ–‡æœ¬
      const ratio = aspectRatios[currentAspectRatioIndex];
      const buttons = document.querySelectorAll('button');
      buttons.forEach(button => {
        if (button.textContent.includes('ç›¸æœºæ¯”ä¾‹')) {
          button.textContent = `ç›¸æœºæ¯”ä¾‹ ${ratio.width}:${ratio.height}`;
        }
      });
    });

    setCamera();
    setSquare();

  </script>
</body>

</html>