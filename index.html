<!DOCTYPE html>
<meta charset="utf-8"></meta>
<html>

<head>
  <title>ç½‘é¡µæ‹ç…§ç¤ºä¾‹ï¼ˆå¸¦ç›¸æœºåˆ‡æ¢ï¼‰</title>
  <style>
    /* æ·»åŠ åŸºæœ¬æ ·å¼ */
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      text-align: center;
    }

    #video-container {
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }

    #video-mask {
      position: absolute;
      display: inline-block;
      border: 2px dashed #fff;
    }

    #video {
      width: 50vmin;
      height: 50vmin;
      object-fit: cover;
    }

    button {
      padding: 10px 20px;
      font-size: 16px;
      margin: 5px;
      margin-top: 16px;
    }

    #photo-container {
      margin-top: 20px;
      text-align: center;
    }
  </style>
</head>

<body>
  <h1>ç½‘é¡µæ‹ç…§</h1>
  <div id="video-container">
    <video id="video" autoplay></video>
    <div id="video-mask"></div>
  </div>
  <button onclick="takePhoto()">æ‹ç…§ ğŸ“·</button>
  <button onclick="switchSquare()">æ­£æ–¹å½¢è£åˆ‡ â—¼ï¸</button>
  <button onclick="switchCamera()">åˆ‡æ¢ç›¸æœº ğŸ”„</button>
  <button onclick="rotateCamera()">æ—‹è½¬ç›¸æœº ğŸ”„</button>
  <button onclick="switchAspectRatio()">ç›¸æœºæ¯”ä¾‹ 16:9</button>
  <div id="photo-container"><canvas id="canvas"></canvas></div>

  <script>
    let stream;
    let video = document.getElementById("video");
    let canvas = document.getElementById("canvas");
    let videoContainer = document.getElementById("video-container");
    let videoMask = document.getElementById("video-mask");
    let currentFacingMode = 'environment'; // é»˜è®¤ä½¿ç”¨åç½®æ‘„åƒå¤´
    let photoContainer = document.getElementById("photo-container");
    let rotateVideo = 0; // è§†é¢‘æ—‹è½¬è§’åº¦ (0, 90, 180, 270)
    let imgIsSquare = false; // æ˜¯å¦è£å‰ªä¸ºæ­£æ–¹å½¢
    let aspectRatios = [
      { width: 16, height: 9 },  // 16:9 æ¯”ä¾‹
      { width: 4, height: 3 }    // 4:3 æ¯”ä¾‹
    ];
    let currentAspectRatioIndex = 0; // å½“å‰ä½¿ç”¨çš„æ¯”ä¾‹ç´¢å¼•

    // åˆå§‹åŒ–æ‘„åƒå¤´
    function initCamera(facingMode) {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }

      // é¦–å…ˆè·å–æ‘„åƒå¤´èƒ½åŠ›ï¼Œå†è®¾ç½®åˆé€‚çš„åˆ†è¾¨ç‡
      navigator.mediaDevices.enumerateDevices()
        .then(devices => {
          const videoDevices = devices.filter(device => device.kind === 'videoinput');
          if (videoDevices.length > 0) {
            // å…ˆè¯·æ±‚ä¸€ä¸ªåŸºç¡€æµä»¥è·å–æ‘„åƒå¤´èƒ½åŠ›
            return navigator.mediaDevices.getUserMedia({ video: { facingMode: facingMode } });
          } else {
            throw new Error("æœªæ‰¾åˆ°è§†é¢‘è®¾å¤‡");
          }
        })
        .then(tempStream => {
          // è·å–è§†é¢‘è½¨é“åŠå…¶èƒ½åŠ›
          const videoTrack = tempStream.getVideoTracks()[0];
          const capabilities = videoTrack.getCapabilities();

          // æ—¥å¿—è¾“å‡ºæ”¯æŒçš„åˆ†è¾¨ç‡èŒƒå›´
          console.log(`ç›¸æœºæ”¯æŒçš„åˆ†è¾¨ç‡èŒƒå›´: ${capabilities.width.min}x${capabilities.height.min} è‡³ ${capabilities.width.max}x${capabilities.height.max}`);

          // åœæ­¢ä¸´æ—¶æµ
          tempStream.getTracks().forEach(track => track.stop());

          // æ ¹æ®æ”¯æŒçš„æœ€å¤§åˆ†è¾¨ç‡å’Œé€‰å®šçš„å®½é«˜æ¯”è®¾ç½®çº¦æŸ
          const currentRatio = aspectRatios[currentAspectRatioIndex];
          let targetWidth, targetHeight;

          // è®¡ç®—åŸºäºæœ€å¤§å®½åº¦çš„ç†æƒ³åˆ†è¾¨ç‡
          if (capabilities.width && capabilities.width.max) {
            targetWidth = Math.min(capabilities.width.max, 1920); // é™åˆ¶åœ¨1920ä»¥å†…
            targetHeight = Math.round(targetWidth * currentRatio.height / currentRatio.width);

            // ç¡®ä¿é«˜åº¦ä¹Ÿåœ¨æ”¯æŒèŒƒå›´å†…
            if (capabilities.height && capabilities.height.max && targetHeight > capabilities.height.max) {
              targetHeight = capabilities.height.max;
              targetWidth = Math.round(targetHeight * currentRatio.width / currentRatio.height);
            }
          } else {
            // å¦‚æœæ— æ³•è·å–æœ€å¤§åˆ†è¾¨ç‡ï¼Œåˆ™ä½¿ç”¨é»˜è®¤å€¼
            targetWidth = 1920;
            targetHeight = Math.round(targetWidth * currentRatio.height / currentRatio.width);
          }

          const constraints = {
            video: {
              facingMode: facingMode,
              width: { ideal: targetWidth },
              height: { ideal: targetHeight }
            }
          };

          console.log(`è®¾ç½®ç›¸æœºåˆ†è¾¨ç‡: ${targetWidth}x${targetHeight}`);

          // ä½¿ç”¨ä¼˜åŒ–åçš„çº¦æŸé‡æ–°è¯·æ±‚åª’ä½“æµ
          return navigator.mediaDevices.getUserMedia(constraints);
        })
        .then(function (s) {
          stream = s;
          video.srcObject = s;

          // è§†é¢‘å…ƒæ•°æ®åŠ è½½åè·å–å®é™…å®½é«˜æ¯”ä¾‹
          return new Promise((resolve) => {
            video.onloadedmetadata = () => {
              const videoWidth = video.videoWidth;
              const videoHeight = video.videoHeight;
              console.log(`å®é™…è§†é¢‘åˆ†è¾¨ç‡: ${videoWidth}x${videoHeight}, æ¯”ä¾‹: ${videoWidth / videoHeight}`);

              // è®¡ç®—å®½é«˜æ¯”å¹¶è®¾ç½®å®¹å™¨æ ·å¼
              if (videoWidth && videoHeight) {
                const aspectRatio = videoWidth / videoHeight;
                video.style.width = `${video.offsetHeight * aspectRatio}px`;
                video.setAttribute('width', video.style.width);
                video.style.height = `${video.offsetHeight}px`;
                video.setAttribute('height', video.style.height);
                videoMask.style.width = video.style.height;
                videoMask.style.height = video.style.height;
                setSquare();
              }

              resolve();
            };
          });
        })
        .catch(function (error) {
          console.error("æ— æ³•è·å–æ‘„åƒå¤´: ", error);
          alert("æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼Œè¯·ç¡®ä¿æ‚¨å·²æˆäºˆæƒé™ã€‚");
        });
    }

    // æ‹ç…§å‡½æ•°
    function takePhoto() {
      const displayWidth = video.offsetWidth;
      const displayHeight = video.offsetHeight;

      // æ ¹æ®æ—‹è½¬è§’åº¦ç¡®å®šCanvaså°ºå¯¸
      const canvasWidth = (rotateVideo === 90 || rotateVideo === 270) ? displayHeight : displayWidth;
      const canvasHeight = (rotateVideo === 90 || rotateVideo === 270) ? displayWidth : displayHeight;
      canvas.width = canvasWidth;
      canvas.height = canvasHeight;

      const ctx = canvas.getContext("2d");

      if (rotateVideo === 90) {
        // é¡ºæ—¶é’ˆæ—‹è½¬90åº¦
        ctx.translate(canvasWidth, 0);
        ctx.rotate(90 * Math.PI / 180);
      } else if (rotateVideo === 180) {
        // æ—‹è½¬180åº¦
        ctx.translate(canvasWidth, canvasHeight);
        ctx.rotate(180 * Math.PI / 180);
      } else if (rotateVideo === 270) {
        // é€†æ—¶é’ˆæ—‹è½¬90åº¦(æˆ–é¡ºæ—¶é’ˆ270åº¦)
        ctx.translate(0, canvasHeight);
        ctx.rotate(-90 * Math.PI / 180);
      }

      // ç»˜åˆ¶è§†é¢‘å†…å®¹
      ctx.drawImage(
        video,
        0,
        0,
        displayWidth,
        displayHeight);

      // åˆ›å»ºå¹¶æ˜¾ç¤ºå›¾ç‰‡
      const img = document.createElement("img");

      // å¦‚æœéœ€è¦è£å‰ªä¸ºæ­£æ–¹å½¢ï¼Œåˆ™è¿›è¡Œè£å‰ª 
      if (imgIsSquare) {
        const minDimension = Math.min(canvasWidth, canvasHeight);
        const startX = (canvasWidth - minDimension) / 2;
        const startY = (canvasHeight - minDimension) / 2;
        const croppedCanvas = document.createElement("canvas");
        croppedCanvas.width = minDimension;
        croppedCanvas.height = minDimension;
        const croppedCtx = croppedCanvas.getContext("2d");
        croppedCtx.drawImage(canvas, startX, startY, minDimension, minDimension,
          0, 0, minDimension, minDimension);
        img.src = croppedCanvas.toDataURL("image/png");
      } else {
        img.src = canvas.toDataURL("image/png");
      }

      img.style.maxWidth = "100%";
      img.alt = "æ‹æ‘„çš„ç…§ç‰‡";

      photoContainer.innerHTML = '';
      photoContainer.appendChild(img);
    }


    //æ§åˆ¶æ­£æ–¹å½¢æ˜¾ç¤º
    function setSquare() {
      if (imgIsSquare) {
        videoContainer.style.width = video.style.height;
        videoContainer.style.height = video.style.height;
        videoContainer.style.removeProperty('zoom');
        photoContainer.style.removeProperty('zoom');
      } else {
        if (rotateVideo === 90 || rotateVideo === 270) {
          videoContainer.style.width = video.offsetHeight + 'px';
          videoContainer.style.height = video.offsetWidth + 'px';
          videoContainer.style.zoom = `calc(${video.offsetHeight / video.offsetWidth})`;
          photoContainer.style.zoom = `calc(${video.offsetHeight / video.offsetWidth})`;
        } else {
          videoContainer.style.width = video.style.width;
          videoContainer.style.height = video.style.height;
          videoContainer.style.removeProperty('zoom');
          photoContainer.style.removeProperty('zoom');
        }
      }
    }

    function switchSquare() {
      imgIsSquare = !imgIsSquare; // åˆ‡æ¢æ­£æ–¹å½¢è£å‰ªçŠ¶æ€
      setSquare();
    }

    // åˆ‡æ¢ç›¸æœºå‡½æ•°
    function switchCamera() {
      currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
      initCamera(currentFacingMode);
    }

    // æ—‹è½¬ç›¸æœºå‡½æ•°
    function setCamera() {
      video.style.transform = `rotate(${rotateVideo}deg)`;
    }

    function rotateCamera() {
      // åœ¨0, 90, 180, 270ä¹‹é—´å¾ªç¯åˆ‡æ¢
      if (rotateVideo === 0) {
        rotateVideo = 90;
      } else if (rotateVideo === 90) {
        rotateVideo = 180;
      } else if (rotateVideo === 180) {
        rotateVideo = 270;
      } else if (rotateVideo === 270) {
        rotateVideo = 0;
      }

      setCamera();
      setSquare();
    }

    // åˆ‡æ¢ç”»é¢æ¯”ä¾‹
    function switchAspectRatio() {
      currentAspectRatioIndex = (currentAspectRatioIndex + 1) % aspectRatios.length;
      const ratio = aspectRatios[currentAspectRatioIndex];
      console.log(`åˆ‡æ¢åˆ° ${ratio.width}:${ratio.height} æ¯”ä¾‹`);
      
      // æ›´æ–°æŒ‰é’®æ–‡æœ¬æ˜¾ç¤ºå½“å‰æ¯”ä¾‹
      const ratioButtons = document.querySelectorAll('button');
      ratioButtons.forEach(button => {
        if (button.textContent.includes('åˆ‡æ¢æ¯”ä¾‹')) {
          button.textContent = `åˆ‡æ¢æ¯”ä¾‹ ${ratio.width}:${ratio.height}`;
        }
      });
      
      initCamera(currentFacingMode);
    }

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–æ‘„åƒå¤´
    document.addEventListener('DOMContentLoaded', () => {
      initCamera(currentFacingMode);
      // åˆå§‹åŒ–æ—¶è®¾ç½®æ¯”ä¾‹æŒ‰é’®çš„æ–‡æœ¬
      const ratio = aspectRatios[currentAspectRatioIndex];
      const ratioButtons = document.querySelectorAll('button');
      ratioButtons.forEach(button => {
        if (button.textContent.includes('åˆ‡æ¢æ¯”ä¾‹')) {
          button.textContent = `åˆ‡æ¢æ¯”ä¾‹ ${ratio.width}:${ratio.height}`;
        }
      });
    });

    setCamera();
    setSquare();

  </script>
</body>

</html>